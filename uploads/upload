app.post('/upload', upload.single('photo'), async (req, res) => {
  const { comment } = req.body;
  let filename = req.file.filename;
  const filepath = path.join(__dirname, 'uploads', filename);

  // HEICをJPEGに変換
  if (req.file.mimetype === 'image/heic' || req.file.originalname.toLowerCase().endsWith('.heic')) {
    const inputBuffer = fs.readFileSync(filepath);
    const outputBuffer = await heicConvert({
      buffer: inputBuffer,
      format: 'JPEG',
      quality: 1
    });

    const newFilename = filename.replace(/\.heic$/i, '.jpg');
    fs.writeFileSync(path.join(__dirname, 'uploads', newFilename), outputBuffer);
    fs.unlinkSync(filepath); // 元のHEICを削除
    filename = newFilename;
  }

  const photo = {
    id: Date.now(),
    url: `/uploads/${filename}`,
    comment,
    room: null,
    timestamp: new Date()
  };
  photoDB.push(photo);
  res.redirect('/thanks.html');
});
