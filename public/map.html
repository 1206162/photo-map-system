<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>写真一覧と地図表示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 10px;
    }
    .gallery img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
    }
    #map-view {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #map-svg-container {
      width: 100%;
      max-width: 720px;
    }
    svg {
      width: 100%;
      height: auto;
    }
    .highlight {
      stroke: red;
      stroke-width: 4;
      fill: rgba(255, 0, 0, 0.3);
    }
    .room {
      fill: transparent;
    }
    .map-image {
      display: none;
    }
    .map-image.active {
      display: block;
    }
    .button-bar {
      text-align: center;
      margin: 15px;
    }
    .button-bar a, .button-bar button {
      background: #007BFF;
      color: white;
      padding: 10px 16px;
      text-decoration: none;
      border-radius: 6px;
      font-size: 1rem;
      margin: 0 6px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center; margin-top: 12px;">写真一覧</h2>
  <div class="gallery" id="gallery"></div>


  <div id="map-view" onclick="hideMap()">
    <div id="map-svg-container">
      <div class="map-image" id="map-floor-1">
        <img src="map1.jpg" style="width:100%;">
        <svg viewBox="0 0 720 1040">
          <!-- 例: <rect id="room-201" class="room" x="100" y="300" width="100" height="80"/> -->
        </svg>
      </div>
      <div class="map-image" id="map-floor-2">
        <img src="map2.jpg" style="width:100%;">
        <svg viewBox="0 0 720 1040">
        </svg>
      </div>
      <div class="map-image" id="map-floor-3">
        <img src="map3.jpg" style="width:100%;">
        <svg viewBox="0 0 720 1040">
        </svg>
      </div>
    </div>
  </div>

   <div class="button-bar">
    <a href="/index.html">写真を投稿する</a>
    <a href="https://docs.google.com/forms/d/e/XXXXXXXXXXXXXXXXXXXXXXXXXXX/viewform" target="_blank">利用者アンケートに回答</a>
  </div>

  <script>
    const roomShapes = {
       1: {
        '402': { x: 430, y: 0, width: 130, height: 250 },
        '403': { x: 415, y: 385, width: 145, height: 117 },
        '404': { x: 415, y: 503, width: 145, height: 117 },
        '405': { x: 415, y: 621, width: 145, height: 117 },
        '406': { x: 415, y: 738, width: 145, height: 117 },
        '407': { x: 150, y: 854, width: 140, height: 78 },
        '408': { x: 150, y: 776, width: 215, height: 78 },
        '409': { x: 150, y: 698, width: 215, height: 78 },
        '410': { x: 150, y: 620, width: 215, height: 78 },
        '411': { x: 150, y: 424, width: 142, height: 115 },
        '412': { x: 150, y: 308, width: 142, height: 115},
        '413': { x: 150, y: 80, width: 214, height: 170 }
      },
      2: {
        '1004': { x: 417, y: 195, width: 143, height: 100 },
        '1005': { x: 417, y: 295, width: 143, height: 100 },
        '1008': { x: 460, y: 500, width: 100, height: 150 },
        '1009': { x: 460, y: 650, width: 100, height: 150 },
        '1020': { x: 150, y: 295, width: 143, height: 100 },
        '1017': { x: 150, y: 500, width: 103, height: 150 }
        
      },
      3: {
        '1108': { x: 460, y: 500, width: 100, height: 150 },
        '1119': { x: 150, y: 295, width: 143, height: 100 },
        '1116': { x: 150, y: 500, width: 103, height: 150 }
     }
    };

    const maxPerRoom = 3;
    const displayed = {}; // { floor_room: count }

    async function loadPhotos() {
      const res = await fetch('/photos');
      const photos = await res.json();
      const gallery = document.getElementById('gallery');

      photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      photos.forEach(photo => {
        if (!photo.room || !photo.floor) return;
        const key = `${photo.floor}_${photo.room}`;
        if (!displayed[key]) displayed[key] = 0;
        if (displayed[key] >= maxPerRoom) return;
        displayed[key]++;

        const img = document.createElement('img');
        img.src = photo.url;
        img.alt = photo.comment || '';
        img.addEventListener('click', () => showMap(photo.floor, photo.room));
        gallery.appendChild(img);
      });
    }

    function showMap(floor, room) {
      document.querySelectorAll('.map-image').forEach(el => el.classList.remove('active'));
      const mapDiv = document.getElementById(`map-floor-${floor}`);
      if (!mapDiv) return;
      mapDiv.classList.add('active');

      const svg = mapDiv.querySelector('svg');
      svg.innerHTML = '';
      const shape = roomShapes[floor]?.[room];
      if (shape) {
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        Object.entries(shape).forEach(([k, v]) => rect.setAttribute(k, v));
        rect.setAttribute('class', 'highlight');
        svg.appendChild(rect);
      }
      document.getElementById('map-view').style.display = 'flex';
    }

    function hideMap() {
      document.getElementById('map-view').style.display = 'none';
    }

    loadPhotos();
  </script>
  
</body>
</html>
