<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>写真マップ</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    svg { width: 100%; height: auto; display: block; }
    .highlight { stroke: red; stroke-width: 4; fill: rgba(255,0,0,0.2); }
    .room { fill: transparent; stroke: transparent; stroke-width: 1; cursor: pointer; }
    .photo-thumbnail { cursor: pointer; }
    #modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
    }
    #modal-map { max-width: 95vw; max-height: 90vh; position: relative; }
    #modal img {
      max-width: 90vw; max-height: 80vh; border: 4px solid white;
    }
    #floor-label {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.5); color: white;
      padding: 6px 10px; border-radius: 5px; font-size: 1rem;
    }
    #gallery { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; }
    .thumb { width: 45vw; max-width: 180px; cursor: pointer; }
    #back-button {
      position: fixed; bottom: 10px; left: 10px;
      background: #eee; padding: 8px 12px; border-radius: 6px;
      font-size: 0.9rem; cursor: pointer;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">写真一覧</h2>
  <div id="gallery"></div>

  <div id="modal">
    <div id="modal-map">
      <div id="floor-label"></div>
      <svg id="map-svg" viewBox="0 0 720 1040"></svg>
      <div id="back-button">一覧に戻る</div>
    </div>
  </div>

  <script>
    const floorBackgrounds = {
      1: 'url("map1.jpg")',
      2: 'url("map2.jpg")',
      3: 'url("map3.jpg")'
    };

    let allPhotos = [];

    async function loadPhotos() {
      const res = await fetch('/photos');
      allPhotos = await res.json();
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      allPhotos.forEach(photo => {
        const img = document.createElement('img');
        img.src = photo.url;
        img.className = 'thumb';
        img.addEventListener('click', () => showMap(photo));
        gallery.appendChild(img);
      });
    }

    function showMap(photo) {
      const modal = document.getElementById('modal');
      const svg = document.getElementById('map-svg');
      const label = document.getElementById('floor-label');
      const floor = photo.floor || 1;

      // 背景変更
      svg.innerHTML = `<image href="map${floor}.jpg" x="0" y="0" width="720" height="1040" />`;
      label.innerText = `${floor}階`;

      // ハイライト部屋追加
      const roomId = photo.room;
      const roomData = roomShapes[floor]?.[roomId];
      if (roomData) {
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        Object.entries(roomData).forEach(([key, val]) => rect.setAttribute(key, val));
        rect.classList.add('highlight');
        svg.appendChild(rect);
      }

      modal.style.display = 'flex';
    }

    document.getElementById('back-button').addEventListener('click', () => {
      document.getElementById('modal').style.display = 'none';
    });

    const roomShapes = {
       1: {
        '402': { x: 430, y: 0, width: 130, height: 250 },
        '403': { x: 415, y: 385, width: 145, height: 117 },
        '404': { x: 415, y: 503, width: 145, height: 117 },
        '405': { x: 415, y: 621, width: 145, height: 117 },
        '406': { x: 415, y: 738, width: 145, height: 117 },
        '407': { x: 150, y: 854, width: 140, height: 78 },
        '408': { x: 150, y: 776, width: 215, height: 78 },
        '409': { x: 150, y: 698, width: 215, height: 78 },
        '410': { x: 150, y: 620, width: 215, height: 78 },
        '411': { x: 150, y: 424, width: 142, height: 115 },
        '412': { x: 150, y: 308, width: 142, height: 115},
        '413': { x: 150, y: 80, width: 214, height: 170 }
      },
      2: {
        '1004': { x: 417, y: 195, width: 143, height: 100 },
        '1005': { x: 417, y: 295, width: 143, height: 100 },
        '1008': { x: 460, y: 500, width: 100, height: 150 },
        '1009': { x: 460, y: 650, width: 100, height: 150 },
        '1020': { x: 150, y: 295, width: 143, height: 100 },
        '1017': { x: 150, y: 500, width: 103, height: 150 },
        
      },
      3: {
        '1108': { x: 460, y: 500, width: 100, height: 150 },
        '1119': { x: 150, y: 295, width: 143, height: 100 },
        '1116': { x: 150, y: 500, width: 103, height: 150 },
     }
    };

    loadPhotos();
  </script>
</body>
</html>
