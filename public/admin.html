<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>管理者画面</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .photo-list { display: flex; flex-wrap: wrap; gap: 20px; }
    .photo-card { border: 1px solid #ccc; padding: 10px; width: 220px; }
    .photo-card img { max-width: 200px; max-height: 200px; }
  </style>
</head>
<body>
  <h2>写真管理</h2>

  <!-- ✅ フィルタチェックボックス -->
  <label>
    <input type="checkbox" id="filter-unapproved">
    未承認の写真のみ表示
  </label>

  <div class="photo-list" id="photoList"></div>

  <script>
    const rooms = ['402', '403', '404', '405' , '406', '407', '408', '409', '410', '411', '412', '413'];

    // ✅ チェックボックスの変化で再読み込み
    document.getElementById('filter-unapproved').addEventListener('change', fetchAndRenderPhotos);

    // ✅ データ取得＆フィルタ処理
    async function fetchAndRenderPhotos() {
      const res = await fetch('/admin/photos');
      const photos = await res.json();

      const showUnapprovedOnly = document.getElementById('filter-unapproved').checked;
      const filtered = showUnapprovedOnly ? photos.filter(p => !p.approved) : photos;

      renderPhotoList(filtered);
    }

    // ✅ 表示描画ロジック
    function renderPhotoList(photos) {
      const container = document.getElementById('photoList');
      container.innerHTML = '';

      photos.forEach(photo => {
        const card = document.createElement('div');
        card.className = 'photo-card';

        card.innerHTML = `
          <img src="${photo.url}" alt="photo">
          <p>${photo.comment || ''}</p>
          <select>
            ${rooms.map(r => `<option value="${r}" ${r === photo.room ? 'selected' : ''}>${r}</option>`).join('')}
          </select>
          <label><input type="checkbox" ${photo.approved ? 'checked' : ''}> 承認</label>
          <button>保存</button>
        `;

        const button = card.querySelector('button');
        button.onclick = async () => {
          const approved = card.querySelector('input[type="checkbox"]').checked;
          const room = card.querySelector('select').value;

          await fetch('/admin/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: photo.id, room, approved })
          });

          alert('保存しました');
          fetchAndRenderPhotos(); // 再読み込み（フィルタ状態維持）
        };

        container.appendChild(card);
      });
    }

    // ✅ 初期表示
    fetchAndRenderPhotos();
  </script>
</body>
</html>
